<!DOCTYPE html>

<html>

  <head>

    <title>Virtual World Framework</title>

    <script type="text/javascript" src="qunit.js"></script>

    <script type="text/javascript" src="../lib/jquery-1.6.2.js"></script>
    <script type="text/javascript" src="../lib/async.js"></script>

    <script type="text/javascript" src="../lib/vwf.js"></script>
    <script type="text/javascript" src="../lib/vwf-view.js"></script>

    <script type="text/javascript" src="../lib/require.js"></script>

    <script type="text/javascript">

      require( {

        baseUrl: "../lib"

      }, [

        "domReady",

        "vwf/kernel/model",
        "vwf/model/javascript",
        "vwf/model/object",
        "vwf/model/stage/log",
        "vwf/kernel/view",

      ], function( ready ) {

        ready( function() {

          vwf.initialize(
            /* models */ { "vwf/model/javascript": undefined, "vwf/model/object": undefined },
            /*  views */ { }
          );

          // Event firing directly from the kernel

          asyncTest( "Event firing kernel", function() {

            createFixture( function( nodeID ) {

              vwf.fireEvent( nodeID, "empty" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "empty", result: [] }, "no parameters declared, no parameters passed" );

              vwf.fireEvent( nodeID, "empty", [ true, 1 ] );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "empty", result: [ true, 1 ] }, "no parameters declared, parameters passed" );

              vwf.fireEvent( nodeID, "parameters" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "parameters", result: [] }, "parameters declared, no parameters passed" );

              vwf.fireEvent( nodeID, "parameters", [ 'abc', false, 2 ] );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "parameters", result: [ 'abc', false, 2 ] }, "parameters declared, parameters passed" );

              start();
            } );

          } );

          // Event firing from JavaScript

          asyncTest( "Event firing JavaScript", function() {

            createFixture( function( nodeID ) {

              vwf.execute( nodeID, "this.empty()" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "empty", result: [] }, "no parameters declared, no parameters passed" );

              vwf.execute( nodeID, "this.empty( true, 1 )" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "empty", result: [ true, 1 ] }, "no parameters declared, parameters passed" );

              vwf.execute( nodeID, "this.parameters()" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "parameters", result: [] }, "parameters declared, no parameters passed" );

              vwf.execute( nodeID, "this.parameters( 'abc', false, 2 )" );
              deepEqual( vwf.execute( nodeID, "this.test" ), { event: "parameters", result: [ 'abc', false, 2 ] }, "parameters declared, parameters passed" );

              start();
            } );

          } );

          // Event inheritance directly from the kernel

          asyncTest( "Event inheritance kernel", function() {

            createFixtureDerivedBase( function( derivedID, baseID ) {

              vwf.execute( derivedID, "this.derived = this.events.add( function( result ) { this.test = result }, this )" );
              vwf.execute( derivedID, "this.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.execute( baseID, "this.derived = this.events.add( function( result ) { this.test = result }, this )" );
              vwf.execute( baseID, "this.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.fireEvent( derivedID, "derived", [ 'derived-' + derivedID ] );
              equal( vwf.execute( derivedID, "this.test" ), "derived-" + derivedID, "derived event from derived" );

              vwf.fireEvent( derivedID, "base", [ 'base-' + derivedID ] );
              equal( vwf.execute( derivedID, "this.test" ), "base-" + derivedID, "base event from derived" );

              vwf.fireEvent( baseID, "derived", [ 'derived-' + baseID ] );
              equal( vwf.execute( baseID, "this.test" ), undefined, "derived event not visible in base" );

              vwf.fireEvent( baseID, "base", [ 'base-' + baseID ] );
              equal( vwf.execute( baseID, "this.test" ), "base-" + baseID, "base event from base" );
              
              start();
            } );

          } );

          // Event inheritance from JavaScript direct properties

          asyncTest( "Event inheritance JavaScript direct", function() {

            createFixtureDerivedBase( function( derivedID, baseID ) {

              vwf.execute( derivedID, "this.derived = this.events.add( function( result ) { this.test = result }, this )" );
              vwf.execute( derivedID, "this.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.execute( baseID, "this.derived && ( this.derived = this.events.add( function( result ) { this.test = result } ), this )" );
              vwf.execute( baseID, "this.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.execute( derivedID, "this.derived( 'derived-' + this.id )" );
              equal( vwf.execute( derivedID, "this.test" ), "derived-" + derivedID, "derived event from derived" );

              vwf.execute( derivedID, "this.base( 'base-' + this.id )" );
              equal( vwf.execute( derivedID, "this.test" ), "base-" + derivedID, "base event from derived" );

              vwf.execute( baseID, "this.derived && this.derived( 'derived-' + this.id )" );
              equal( vwf.execute( baseID, "this.test" ), undefined, "derived event not visible in base" );

              vwf.execute( baseID, "this.base( 'base-' + this.id )" );
              equal( vwf.execute( baseID, "this.test" ), "base-" + baseID, "base event from base" );
              
              start();
            } );

          } );

          // Event inheritance from JavaScript collection properties

          asyncTest( "Event inheritance JavaScript collection", function() {

            createFixtureDerivedBase( function( derivedID, baseID ) {

              vwf.execute( derivedID, "this.events.derived = this.events.add( function( result ) { this.test = result }, this )" );
              vwf.execute( derivedID, "this.events.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.execute( baseID, "this.events.derived && ( this.events.derived = this.events.add( function( result ) { this.test = result } ), this )" );
              vwf.execute( baseID, "this.events.base = this.events.add( function( result ) { this.test = result }, this )" );

              vwf.execute( derivedID, "this.events.derived( 'derived-' + this.id )" );
              equal( vwf.execute( derivedID, "this.test" ), "derived-" + derivedID, "derived event from derived" );

              vwf.execute( derivedID, "this.events.base( 'base-' + this.id )" );
              equal( vwf.execute( derivedID, "this.test" ), "base-" + derivedID, "base event from derived" );

              vwf.execute( baseID, "this.events.derived && this.events.derived( 'derived-' + this.id )" );
              equal( vwf.execute( baseID, "this.test" ), undefined, "derived event not visible in base" );

              vwf.execute( baseID, "this.events.base( 'base-' + this.id )" );
              equal( vwf.execute( baseID, "this.test" ), "base-" + baseID, "base event from base" );
              
              start();
            } );

          } );

          // Event listeners through JavaScript

          asyncTest( "Event listeners JavaScript", function() {

            createFixture( function( nodeID ) {

              vwf.execute( nodeID, "this.empty = this.events.add( this.test.listener1 = function() { this.test.count1 = ( this.test.count1 || 0 ) + 5 }, this )" );
              vwf.execute( nodeID, "this.empty = this.events.add( this.test.listener2 = function() { this.test.count2 = ( this.test.count2 || 0 ) + 7 }, this )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 5, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 7, "" );

              vwf.execute( nodeID, "this.empty = this.events.remove( this.test.listener1 )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 5, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 14, "" );

              vwf.execute( nodeID, "this.empty = this.events.add( this.test.listener1, this )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 10, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 21, "" );

              vwf.execute( nodeID, "this.empty = this.events.remove( this.test.listener2 )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 15, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 21, "" );

              vwf.execute( nodeID, "this.empty = this.events.remove( this.test.listener1 )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 15, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 21, "" );

              vwf.execute( nodeID, "this.empty = this.events.add( this.test.listener1, this )" );
              vwf.execute( nodeID, "this.empty = this.events.add( this.test.listener2, this )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 20, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 28, "" );

              vwf.execute( nodeID, "this.empty = this.events.flush( this )" );
              vwf.execute( nodeID, "this.empty()" );
              equal( vwf.execute( nodeID, "this.test.count1" ), 20, "" );
              equal( vwf.execute( nodeID, "this.test.count2" ), 28, "" );

              vwf.execute( nodeID, "this.empty = function() {}" );  // TODO: should invoke with this as the global object, but how to test?
              vwf.execute( nodeID, "this.empty()" );

              start();
            } );

          } );

          // TODO: event inheritance

          // == Helper functions =====================================================================

          // Create a node with events to fire.

          function createFixture( callback ) {

            vwf.createNode( 0, {

              extends:
                "http://vwf.example.com/types/node",

              events: {

                empty: undefined,
                parameters: { parameters: [] },

              },

              scripts: [
                "this.test = {}",
                "this.empty = this.events.add( function() { this.test.event = 'empty'; this.test.result = Array.prototype.slice.call( arguments ) }, this )",
                "this.parameters = this.events.add( function() { this.test.event = 'parameters'; this.test.result = Array.prototype.slice.call( arguments ) }, this )",
              ],

            }, unique_name( "node" ), function( nodeID ) {

                callback( nodeID );

            } );

          }

          // Create a node with two levels of inheritance and events to fire.

          function createFixtureDerivedBase( callback ) {

            vwf.createNode( 0, {

              extends: "http://vwf.example.com/types/node",
              events: { base: undefined },
              scripts: [ ],

            }, unique_name( "base" ), function( baseID ) {

              vwf.createNode( 0, {

                extends: "@" + JSON.stringify( baseID ),
                events: { derived: undefined },
                scripts: [ ],

              }, unique_name( "derived" ), function( derivedID ) {

                callback( derivedID, baseID );

              } );

            } );

          }
         
          // Create a unique name from a base.

          var sequence = 0;

          function unique_name( base ) {
            return base + "-" + ( ++sequence );
          }

       } );

      } );

    </script>

    <link rel="stylesheet" type="text/css" href="qunit.css" />

  </head>

  <body>

    <h1 id="qunit-header">Virtual World Framework</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>

    <div id="qunit-fixture">test markup, will be hidden</div>

  </body>

</html>
