<!DOCTYPE html>
<!--
/*
 * Copyright (C) 2009 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
 -->
<html>
  <head>
    <title>Earth and Mars</title>

    <script type="text/javascript" src="jquery-1.4.4.js"></script>
    <script type="text/javascript" src="jquery-getquerystring.js"></script>
    <script type="text/javascript" src="socket.io/socket.io.js"></script>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript" src="vwf-shard-javascript.js"></script>
    <script type="text/javascript" src="vwf-shard-html.js"></script>
    <script type="text/javascript" src="vwf-shard-webgl.js"></script>

    <script type="text/javascript">

      // vwf.node.constructed = function() { jQuery( "#vwf-root" ).append( "<div><p>" + nodeToPath( this ) + "</p></div>" ) }

      var earthNodeID = 1;
      var marsNodeID = 2;

      var earthActive = true;
      var marsActive = true;
      
      var earthAngle = 0;
      var marsAngle = 0;
      
      var time = lastTime = 0;
      
      var timeSetter = function( t ) {
        lastTime = time;
        time = t;
        if ( earthActive ) {
            earthAngle += ( time - lastTime ) * 0.02;
            if ( earthAngle > 360 )
                earthAngle -= 360;
        }
        if ( marsActive ) {
            marsAngle += ( time - lastTime ) * 0.02;
            if ( marsAngle > 360 )
                marsAngle -= 360;
        }
      }

      var enabledSetter = function( nodeID, enabled ) {
        if ( nodeID == earthNodeID )
          earthActive = enabled;
        else if ( nodeID == marsNodeID )
          marsActive = enabled;
      }

      var angleSetter = function( nodeID, angle ) {
        if ( nodeID == earthNodeID )
          earthAngle = angle;
        else if ( nodeID == marsNodeID )
          marsAngle = angle;
      }

      $(document).ready( function() {
        vwf.addEngine( new vwf.webgl( vwf, { tick: timeSetter, enabled: enabledSetter, angle: angleSetter } ) );
        vwf.addEngine( new vwf.html( vwf, "#vwf-root" ) );
        vwf.addEngine( new vwf.js( vwf ) );
        vwf.initialize();
      } )

      // function nodeToPath( node ) { var path = ""; while ( node && node.name ) { path = node.name + "." + path; node = node.parent; } return path; }

    </script>

    <link rel="stylesheet" href="index.css" type="text/css" />

    <script type="text/javascript" src="vwf-shard-webgl/common/webgl-utils.js"></script>
    <script src="vwf-shard-webgl/Earth+Mars/resources/J3DI.js"> </script>
    <script src="vwf-shard-webgl/Earth+Mars/resources/J3DIMath.js" type="text/javascript"> </script>

    <script id="vshader" type="x-shader/x-vertex">
        uniform mat4 u_modelViewProjMatrix;
        uniform mat4 u_normalMatrix;
        uniform vec3 lightDir;

        attribute vec3 vNormal;
        attribute vec4 vTexCoord;
        attribute vec4 vPosition;

        varying float v_Dot;
        varying vec2 v_texCoord;

        void main()
        {
            gl_Position = u_modelViewProjMatrix * vPosition;
            v_texCoord = vTexCoord.st;
            vec4 transNormal = u_normalMatrix * vec4(vNormal,1);
            v_Dot = max(dot(transNormal.xyz, lightDir), 0.0);
        }
    </script>

    <script id="fshader" type="x-shader/x-fragment">
#ifdef GL_ES
    precision mediump float;
#endif

        uniform sampler2D sampler2d;

        varying float v_Dot;
        varying vec2 v_texCoord;

        void main()
        {
            vec4 color = texture2D(sampler2d,v_texCoord);
            color += vec4(0.1,0.1,0.1,1);
            gl_FragColor = vec4(color.xyz * v_Dot, color.a);
        }
    </script>

    <script id="fshadergray" type="x-shader/x-fragment">
#ifdef GL_ES
    precision mediump float;
#endif

        uniform sampler2D sampler2d;

        varying float v_Dot;
        varying vec2 v_texCoord;
        
        void main()
        {
            vec4 color = texture2D(sampler2d,v_texCoord);
            color += vec4(0.1,0.1,0.1,1);
            gl_FragColor = vec4( vec3( dot( color.rgb, vec3( 0.2125, 0.7154, 0.0721 ) ) ), color.a ); 
        }
    </script>

    <script>
        function init()
        {
            var gl = initWebGL("example", "vshader", "fshader", "fshadergray",
                                [ "vNormal", "vTexCoord", "vPosition"],
                                [ 0, 0, 0, 1 ], 10000);
            if (!gl) {
              return;
            }

            gl.useProgram(gl.programcolor);
            gl.uniform3f(gl.getUniformLocation(gl.programcolor, "lightDir"), 0, 0, 1);
            gl.uniform1i(gl.getUniformLocation(gl.programcolor, "sampler2d"), 0);

            gl.useProgram(gl.programgray);
            gl.uniform3f(gl.getUniformLocation(gl.programgray, "lightDir"), 0, 0, 1);
            gl.uniform1i(gl.getUniformLocation(gl.programgray, "sampler2d"), 0);

            gl.useProgram(gl.programcolor);
            gl.program = gl.programcolor;

            gl.enable(gl.TEXTURE_2D);

            gl.sphere = makeSphere(gl, 1, 30, 30);

            // get the images
            earthTexture = loadImageTexture(gl, "vwf-shard-webgl/Earth+Mars/resources/earthmap1k.jpg");
            earthTextureGray = loadImageTexture(gl, "vwf-shard-webgl/Earth+Mars/resources/earthmap1kgray.jpg");
            marsTexture = loadImageTexture(gl, "vwf-shard-webgl/Earth+Mars/resources/mars500x250.png");
            marsTextureGray = loadImageTexture(gl, "vwf-shard-webgl/Earth+Mars/resources/mars500x250gray.png");

            return gl;
        }

        var width = -1;
        var height = -1;
        var framerate;

        function reshape(ctx)
        {
            var canvas = document.getElementById('example');
            if (canvas.width == width && canvas.width == height)
                return;

            width = canvas.width;
            height = canvas.height;

            ctx.viewport(0, 0, width, height);

            ctx.perspectiveMatrix = new J3DIMatrix4();
            ctx.perspectiveMatrix.perspective(30, width/height, 1, 10000);
            ctx.perspectiveMatrix.lookat(0,0,6, 0, 0, 0, 0, 1, 0);
        }

        function drawOne(ctx, angle, x, y, z, scale, texture)
        {
            // setup VBOs
            ctx.enableVertexAttribArray(0);
            ctx.enableVertexAttribArray(1);
            ctx.enableVertexAttribArray(2);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, ctx.sphere.vertexObject);
            ctx.vertexAttribPointer(2, 3, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, ctx.sphere.normalObject);
            ctx.vertexAttribPointer(0, 3, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ARRAY_BUFFER, ctx.sphere.texCoordObject);
            ctx.vertexAttribPointer(1, 2, ctx.FLOAT, false, 0, 0);

            ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER, ctx.sphere.indexObject);

            // generate the model-view matrix
            var mvMatrix = new J3DIMatrix4();
            mvMatrix.translate(x,y,z);
            mvMatrix.rotate(30, 1,0,0);
            mvMatrix.rotate(angle, 0,1,0);
            mvMatrix.scale(scale, scale, scale);

            // construct the normal matrix from the model-view matrix
            var normalMatrix = new J3DIMatrix4(mvMatrix);
            normalMatrix.invert();
            normalMatrix.transpose();
            normalMatrix.setUniform(ctx, ctx.getUniformLocation(ctx.program, "u_normalMatrix"), false);

            // construct the model-view * projection matrix
            var mvpMatrix = new J3DIMatrix4(ctx.perspectiveMatrix);
            mvpMatrix.multiply(mvMatrix);
            mvpMatrix.setUniform(ctx, ctx.getUniformLocation(ctx.program, "u_modelViewProjMatrix"), false);

            ctx.bindTexture(ctx.TEXTURE_2D, texture);
            ctx.drawElements(ctx.TRIANGLES, ctx.sphere.numIndices, ctx.UNSIGNED_SHORT, 0);
        }

        function drawPicture(ctx)
        {
            reshape(ctx);
            ctx.clear(ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT);

            drawOne(ctx, earthAngle, -1, 0, 0, 1, (earthActive ? earthTexture : earthTextureGray));
            drawOne(ctx, -marsAngle, 1, 0, 0, 0.6, (marsActive ? marsTexture : marsTextureGray));
            ctx.flush();

            framerate.snapshot();

            // if (earthActive)
            // {
            //   earthAngle += incAngle;
            //   if (earthAngle > 360)
            //       earthAngle -= 360;
            // }

            // if (marsActive)
            // {
            //   marsAngle += incAngle;
            //   if (marsAngle > 360)
            //       marsAngle -= 360;
            // }
        }

        function start()
        {
            var c = document.getElementById("example");
            var w = Math.floor(window.innerWidth * 0.7);
            var h = Math.floor(window.innerHeight * 0.9);

            c.width = w;
            c.height = h;

            var ctx = init();
            if (!ctx) {
              return;
            }
            framerate = new Framerate("framerate");
            // earthAngle = 0;
            // marsAngle = 0;
            incAngle = 0.2;

            // earthActive = false;
            // marsActive = false;

            var f = function() {
              drawPicture(ctx)
              WebGLUtils.requestAnimationFrame(c, f);
            };
            f();
        }

        $(document).ready
        (
          function()
          {

            $("#example").click( function(event)
              {
                var centerX = this.clientWidth / 2;
                var centerY = this.clientHeight / 2;

                var dim = centerY * 3.1 / 5;

                if ( event.offsetX > (centerX - dim - dim) && event.offsetX < (centerX - dim + dim) &&
                  event.offsetY > centerY - dim && event.offsetY < centerY + dim )
                {
                  // earthActive = !earthActive;
                  vwf.setProperty( earthNodeID, "enabled", !earthActive );
                  $("#lessonearth").addClass( "completed" );
                }

                if (  event.offsetX > (centerX + dim - dim*0.6) && event.offsetX < (centerX + dim + dim*0.6) &&
                  event.offsetY > centerY - dim*0.6 && event.offsetY < centerY + dim*0.6 )
                {
                  // marsActive = !marsActive;
                  vwf.setProperty( marsNodeID, "enabled", !marsActive );
                  $("#lessonmars").addClass( "completed" );
                }
              }
            );

            // $("#lessonearth").click( function() { earthActive = !earthActive } );
            // $("#lessonmars").click( function() { marsActive = !marsActive } );
            // $("#example").click( function(event) { alert(event.offsetX + " " + event.offsetY + " "+ this.clientWidth + " " + this.clientHeight ) } );
          }
        );

    </script>
    <style type="text/css">
        canvas { border: 2px solid black; }
        td.lesson  { vertical-align: top; font-family: 'Trebuchet MS', Verdana, Helvetica, Arial, sans-serif; font-weight: bold; background: #fff8f0; width: 15em; }
        .lesson h2 { margin: 10px 0;}
        .lesson li { margin: 10px 5px; }
        .completed { color: #008000; }
    </style>
  </head>

  <body onload="start()">

    <table border="0" cellspacing="5" cellpadding="5">
      <tr>
        <td>
          <canvas id="example">
            There is supposed to be an example drawing here, but it's not important.
          </canvas>
        </td>
        <!-- td class="lesson">
          <h2>Lesson</h2>
          <ol>
            <li id="lessonearth">Click on Earth</li>
            <li id="lessonmars">Click on Mars</li>
          </ol>
        </td -->
      </tr>
    </table>
    <div id="framerate"></div>
    <div id="console"></div>

    <div id="vwf-root"></div>
    <div id="vwf-orphans"></div>

  </body>

</html>
