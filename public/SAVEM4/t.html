<!-- Copyright 2014, SRI International -->
<html>
  <script src="vwf/model/threejs/three.js"></script>
  <script src="vwf/model/threejs/js/loaders/ColladaLoader.js"></script>
  <script src="js/tween.min.js"></script>
  <script src="js/tow.js"></script>
  <script src="js/dat.gui.min.js"></script>
  <script>
TOW.Camera.position.set(-0.25, 0, 0.125); //XXX make dat gui able to set this vector maybe
// TOW.Camera.position.set(-10, 5, 5);
TOW.Camera.lookAt(new THREE.Vector3(0, 0, 0));
TOW.addLight().position.set(-1, 0.5, 0.5);
TOW.addLight({ type: 'Ambient' });
TOW.addGrid(14, 0.125, 0x303030);
TOW.loadCollada('models/xyzbar.dae', 'xyzbar_dae', true, function() {
  TOW.ColladaScenes.xyzbar_dae.scale.set(0.005, 0.005, 0.005);
  TOW.render();
});
//TOW.loadCollada('models/M4_Environment_01.dae', 'M4_Environment_01_dae', false, function() { onloadTowDatGui(); });
TOW.loadColladas([ 'models/M4_Environment_01.dae', 'models/M4_v09.dae' ], false, function() { onloadTowDatGui(); });
  </script>

  <script>
var TowDatMenu = function() {
  var self = this;
  var n;

  this.meshCache = { }; // mesh references by name
  this.targets = function() {
    n = 'targets';
    focusSelected(TOW.ColladaScenes.M4_Environment_01_dae);
  };
  this.ShootingRangeArea8 = function() {
    n = 'ShootingRangeArea8';
    focusSelected(TOW.ColladaScenes.M4_Environment_01_dae);
  };
  this.Trigger = function() {
    n = 'Trigger';
    focusTriggerTween(TOW.ColladaScenes.M4_v09_dae);
  };
  this.Selector_Lever = function() {
    n = 'Selector_Lever';
    focusSelected(TOW.ColladaScenes.M4_v09_dae);
  };
  this.Gun_Carrying_Handle = function() {
    n = 'Gun_Carrying_Handle';
    focusSelected(TOW.ColladaScenes.M4_v09_dae);
  };

  function focusSelected(dae, onRender) {
    onRender = onRender || function(delta, pivot) { pivot.rotation.y += 0.005; };

    if (self.meshCache[ n ] === undefined) self.meshCache[ n ] = TOW.findMeshVisibleAndCenterRender(n, dae, onRender);
  }

  function focusTriggerTween(dae) {
    var pivot;

    if (self.meshCache[ n ] === undefined) {
      var pivot =  self.meshCache[ n ] = TOW.findMeshAndVisibleMesh(n, dae);

      TOW.render(function(delta) { pivot.rotation.y += Math.PI * delta; });
    } else {
      return;
    }

    pivot.position.set(0, 0, 0);

    var curZ = { z:  pivot.rotation.z };
    var pull = new TWEEN.Tween(curZ)
      .to({ z: 0.52 }, 1000) // radians and milliseconds
      // .easing(TWEEN.Easing.Elastic.InOut)
      .easing(TWEEN.Easing.Exponential.InOut)
      .onUpdate(function() { curZ = pivot.rotation.z = -this.z; });
    var release = new TWEEN.Tween(curZ)
      .to({ z: 0 }, 500)
      .onUpdate(function() { curZ =  pivot.rotation.z = -this.z })
      .delay(250);

    pull.chain(release);
    release.chain(pull);
    pull.start();
  }
};

// window.onload =
function onloadTowDatGui() {
  var towDatMenu = new TowDatMenu();
  var towDatGUI = new dat.GUI();

  towDatGUI.add(towDatMenu, 'targets');
  towDatGUI.add(towDatMenu, 'ShootingRangeArea8');
  towDatGUI.add(towDatMenu, 'Trigger');
  towDatGUI.add(towDatMenu, 'Selector_Lever');
  towDatGUI.add(towDatMenu, 'Gun_Carrying_Handle');
}
  </script>
<body>
</body>
</html>
