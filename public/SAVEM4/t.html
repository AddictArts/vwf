<html>
<script type="text/javascript" src="vwf/model/threejs/three.js"></script>
<script type="text/javascript" src="vwf/model/threejs/js/loaders/ColladaLoader.js"></script>
<body>
<script>
var scene = undefined;
var renderer = undefined;
var camera = undefined;
var mesh = undefined;

var init = function() {
  var containerWidth  = window.innerWidth;
  var containerHeight = window.innerHeight;
  var loader = new THREE.ColladaLoader();

  // THREE.Scene
  scene = new THREE.Scene();
  loader.load('models/xyzbar.dae', function(collada) {
    collada.scene.name = 'xyzbar_dae';
    // collada.scene.children[0].visible = false; // X
    // collada.scene.children[1].visible = false; // Y
    // collada.scene.children[2].visible = false; // Z
    // scene.add(collada.scene.children[0]); // to drop the parent scene dae transform
    collada.scene.scale.set(0.005, 0.005, 0.005);
    // collada.scene.rotation.x = Math.PI;
    // collada.scene.scale.x = collada.scene.scale.y = collada.scene.scale.z = 1;
    scene.add(collada.scene);

    //Grid
    var size = 14;
    var step = 0.125;
    var geometry = new THREE.Geometry();
    var material = new THREE.LineBasicMaterial({ color: 0x303030 }); // 0x303030
    var line = new THREE.Line(geometry, material, THREE.LinePieces);

    for (var i = -size; i <= size; i += step) {
      geometry.vertices.push(new THREE.Vector3(-size, - 0.04, i));
      geometry.vertices.push(new THREE.Vector3(size, - 0.04, i));
      geometry.vertices.push(new THREE.Vector3(i, - 0.04, -size));
      geometry.vertices.push(new THREE.Vector3(i, - 0.04, size));
    }

    scene.add(line);

    //THREE.Camera
    camera = new THREE.PerspectiveCamera(40, containerWidth / containerHeight, 0.1, 10000);
    camera.position.set(-0.25, 0, 0.125);
    camera.lookAt(new THREE.Vector3(0, 0, 0));

    //THREE.Lights
    light = new THREE.DirectionalLight(0xffffff);
    light.position.set(-1, 0.5, 0.5);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff));

    //THREE.WebGLRenderer
    // var canvas = document.getElementById("canvasID");
    renderer = new THREE.WebGLRenderer({
      // canvas: canvas,
      width: containerWidth,
      height: containerHeight,
      antialias: true
    });
    renderer.setSize(containerWidth, containerHeight);
    document.body.appendChild(renderer.domElement);
    loader.options.convertUpAxis = true;
    loader.load('models/M4_Environment_01.dae', function(collada) {
      collada.scene.name = 'M4_Environment_01_dae';
    // loader.load('models/M4_v09.dae', function(collada) {
    //   collada.scene.name = 'M4_v09_dae';

      var dae = collada.scene;

      dae.traverse(function(child) {
        console.log(child.name);
 
        if (child instanceof THREE.Mesh && child.name == 'targets') {
        // if (child instanceof THREE.Mesh && child.name == 'Trigger') {
        // if (child instanceof THREE.Mesh && child.name == 'Selector_Lever') {
          mesh = child;
        } else {
          child.visible = false;
        }
      });
      scene.add(dae);
      THREE.SceneUtils.detach(mesh, mesh.parent, scene); // detach it from the COLLADA hierarchy, we can safely abandon it

      var delta = THREE.GeometryUtils.center(mesh.geometry.clone());

      console.log(delta);
      mesh.geometry.applyMatrix(new THREE.Matrix4().setPosition(delta));

      // ???
      // mesh.position.y = 10;
      // var pivot = new THREE.Object3D();
      // pivot.add( mesh );
      // scene.add( pivot );

      // THREE.SceneUtils.detach(mesh, mesh.parent, scene);
      // mesh.position.add(THREE.GeometryUtils.center(mesh.geometry.clone())); //XXX add or sub, need to pick

      mesh.position.set(0, 0, 0);
      render();
    });
  });
};
var render = function(t) {
  requestAnimationFrame(render);
  mesh.rotation.y += 0.005;
  renderer.render(scene, camera);
};

init();
</script>
</body>
</html>
